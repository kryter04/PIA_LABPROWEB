---
import MainLayout from '../layouts/MainLayout.astro';

interface Professor {
  professorId: number;
  name: string;
  title: string;
  departmentName?: string;
  photoUrl?: string;
  averageRating: number | null;
  reviewCount: number;
  universities?: string[];
  subjects?: string[];
}

let professors: Professor[] = [];
let hasError = false;

// Helper para dibujar estrellas llenas/vacías
const getStars = (rating: number | null | undefined) =>
  Array.from({ length: 5 }, (_, i) => i < Math.round(rating ?? 0));

try {
  // Usamos la URL completa del backend para SSR (server-side rendering)
  const res = await fetch('http://localhost:8080/api/professors?page=0&size=50');

  if (res.ok) {
    const data = await res.json();
    // Puede venir paginado (data.content) o como lista directa
    professors = (data.content ?? data) as Professor[];
  } else {
    hasError = true;
    console.error('Error al obtener profesores:', res.status);
  }
} catch (err) {
  hasError = true;
  console.error('Error al conectar con el backend:', err);

  // Fallback SOLO para ver la tabla, sin calificaciones (estadísticas vacías)
  professors = [
    {
      professorId: 1,
      name: 'Dr. Alex Turner',
      title: 'Dr.',
      subjects: ['Informática'],
      photoUrl: 'https://placehold.co/40x40',
      averageRating: null,
      reviewCount: 0,
      departmentName: 'Informática',
      universities: ['FIME UANL'],
    },
    {
      professorId: 2,
      name: 'Prof. Olivia Bennett',
      title: 'Prof.',
      subjects: ['Matemáticas'],
      photoUrl: 'https://placehold.co/40x40',
      averageRating: null,
      reviewCount: 0,
      departmentName: 'Matemáticas',
      universities: ['FIME UANL'],
    },
    {
      professorId: 3,
      name: 'Dr. Ethan Carter',
      title: 'Dr.',
      subjects: ['Física'],
      photoUrl: 'https://placehold.co/40x40',
      averageRating: null,
      reviewCount: 0,
      departmentName: 'Física',
      universities: ['FIME UANL'],
    },
    {
      professorId: 4,
      name: 'Prof. Sophia Davis',
      title: 'Prof.',
      subjects: ['Química'],
      photoUrl: 'https://placehold.co/40x40',
      averageRating: null,
      reviewCount: 0,
      departmentName: 'Química',
      universities: ['FIME UANL'],
    },
    {
      professorId: 5,
      name: 'Dr. Noah Evans',
      title: 'Dr.',
      subjects: ['Biología'],
      photoUrl: 'https://placehold.co/40x40',
      averageRating: null,
      reviewCount: 0,
      departmentName: 'Biología',
      universities: ['FIME UANL'],
    },
  ];
}
---

<MainLayout title="RateMyProfs - Inicio">
  <main class="max-w-6xl mx-auto px-4 py-10">
    <section class="mb-8">
      <h1 class="text-2xl font-semibold text-gray-900 mb-4">
        Explora profesores
      </h1>

      <!-- Barra de búsqueda -->
      <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center">
        <input
          id="searchInput"
          type="text"
          placeholder="Buscar un profesor por nombre, materia o universidad"
          class="w-full rounded-full border border-gray-200 px-5 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-green-400"
        />
      </div>

      <!-- Filtros solo visuales -->
      <div class="flex flex-wrap gap-2 mb-6">
        <button class="px-3 py-1.5 text-xs rounded-full border border-gray-200 bg-white hover:bg-gray-50">
          Asignatura
        </button>
        <button class="px-3 py-1.5 text-xs rounded-full border border-gray-200 bg-white hover:bg-gray-50">
          Universidad
        </button>
        <button class="px-3 py-1.5 text-xs rounded-full border border-gray-200 bg-white hover:bg-gray-50">
          Calificación
        </button>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow-sm overflow-hidden">
      <header class="border-b border-gray-100 px-6 py-3">
        <h2 class="text-base font-semibold text-gray-800">Profesores</h2>
        {hasError && (
          <p class="mt-1 text-xs text-red-500">
            No se pudo conectar al backend. Se muestran datos de ejemplo sin calificación.
          </p>
        )}
      </header>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-green-50 text-left text-xs font-semibold text-gray-500">
            <tr>
              <th class="px-6 py-3">Profesor</th>
              <th class="px-6 py-3">Asignatura</th>
              <th class="px-6 py-3">Universidad</th>
              <th class="px-6 py-3">Calificación</th>
            </tr>
          </thead>
          <tbody id="professorsTableBody" class="divide-y divide-gray-100">
            {professors.map((p) => (
              <tr class="hover:bg-gray-50 transition">
                <td class="px-6 py-4">
                  <a
                    href={`/professor?id=${p.professorId}`}
                    class="flex items-center gap-3 group"
                  >
                    <div class="h-9 w-9 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center">
                      {p.photoUrl ? (
                        <img
                          src={p.photoUrl}
                          alt={p.name}
                          class="h-full w-full object-cover"
                        />
                      ) : (
                        <span class="text-xs text-gray-500">
                          {p.name.charAt(0)}
                        </span>
                      )}
                    </div>
                    <div>
                      <p class="text-sm font-medium text-gray-900 group-hover:text-green-600">
                        {p.name}
                      </p>
                      <p class="text-xs text-gray-500">
                        {p.departmentName ?? 'Departamento no definido'}
                      </p>
                    </div>
                  </a>
                </td>

                <td class="px-6 py-4 text-gray-700">
                  {p.subjects && p.subjects.length > 0 ? p.subjects[0] : '—'}
                </td>

                <td class="px-6 py-4 text-gray-700">
                  {p.universities && p.universities.length > 0
                    ? p.universities[0]
                    : '—'}
                </td>

                <td class="px-6 py-4">
                  {p.reviewCount == null || p.reviewCount === 0 || p.averageRating == null ? (
                    <span class="text-xs text-gray-400 italic">
                      Sin calificación
                    </span>
                  ) : (
                    <div class="flex items-center gap-2">
                      <div class="flex">
                        {getStars(p.averageRating).map((filled) => (
                          <span
                            class={filled ? 'text-yellow-400' : 'text-gray-300'}
                            aria-hidden="true"
                          >
                            ★
                          </span>
                        ))}
                      </div>
                      <span class="text-sm text-gray-700">
                        {p.averageRating.toFixed(1)}
                      </span>
                    </div>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Filtro de búsqueda en el cliente (sobre la tabla ya renderizada) -->
  <script>
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('professorsTableBody');

    if (searchInput && tableBody) {
      searchInput.addEventListener('input', () => {
        const term = searchInput.value.toLowerCase();
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach((row) => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
      });
    }
  </script>
</MainLayout>
