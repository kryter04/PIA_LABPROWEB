---
// src/pages/mi-perfil.astro
import MainLayout from '../layouts/MainLayout.astro';
// Este archivo implementa la funcionalidad de la pantalla "Mi Perfil"
---

<MainLayout title="Mi Perfil">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-1">
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 sticky lg:top-24">
        <div class="flex flex-col items-center text-center">
          <div class="relative mb-4">
            <div class="h-24 w-24 text-gray-500 bg-gray-200 rounded-full flex items-center justify-center text-3xl font-bold" id="profile-initial">
              </div>
            <div class="absolute bottom-0 right-0 bg-green-600 p-1 rounded-full border-2 border-white">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.794.793-2.828-2.828.793-.793zm-3.18 3.18l-5 5V15h5l5-5-2.828-2.828-2.172-2.172z"/>
              </svg>
            </div>
          </div>
          <h2 id="profile-name-display" class="text-xl font-semibold text-gray-900">Cargando...</h2>
          <p id="profile-email-display" class="text-sm text-gray-600">...</p>
          <p id="profile-role-display" class="mt-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium hidden"></p>
        </div>
      </div>
    </div>

    <div class="lg:col-span-2 space-y-10">
      
      <div class="bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Editar Perfil</h3>
        
        <form id="updateProfileForm" class="space-y-6">
          <div id="update-message" class="hidden p-3 rounded-lg border">
            <p class="text-sm"></p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
              <input type="text" id="name" name="name" required minlength="2"
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-green focus:border-brand-green sm:text-sm"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
              <input type="email" id="email" name="email" readonly
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-500 cursor-not-allowed sm:text-sm"
              />
            </div>
          </div>
          
          <hr class="border-gray-200" />
          
          <div class="space-y-4">
            <h4 class="text-md font-medium text-gray-900">Cambiar Contrase√±a</h4>
            
            <div>
              <label for="current-password" class="block text-sm font-medium text-gray-700">Contrase√±a Actual</label>
              <input type="password" id="current-password" name="current-password"
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-green focus:border-brand-green sm:text-sm"
                placeholder="Ingresa tu contrase√±a actual para confirmar cambios"
              />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contrase√±a</label>
                <input type="password" id="new-password" name="new-password" minlength="6"
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-green focus:border-brand-green sm:text-sm"
                  placeholder="M√≠nimo 6 caracteres"
                />
              </div>
              <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contrase√±a</label>
                <input type="password" id="confirm-password" name="confirm-password" minlength="6"
                  class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-green focus:border-brand-green sm:text-sm"
                  placeholder="Repite la nueva contrase√±a"
                />
              </div>
            </div>
          </div>

          <div class="text-right pt-4">
            <button type="submit" id="saveChangesBtn"
              class="w-full md:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-opacity-80 transition-colors"
            >
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>

      <div class="bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Mis Comentarios</h3>
        <div id="user-reviews-list" class="space-y-6">
          <p id="no-reviews-message" class="hidden text-gray-500 italic">A√∫n no has escrito ninguna rese√±a.</p>
          <div id="loading-reviews" class="text-center text-gray-500">Cargando rese√±as...</div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script> 
  import $ from 'jquery';
  import { API_BASE_URL, getAuthHeaders, getCurrentUser } from '../config/api.ts';

  interface UserProfile {
      name: string;
      email: string;
      role: string;
  }

  // --- L√ìGICA PRINCIPAL ---
  
  const user = getCurrentUser();
  
  if (!user || !user.userId) {
      // SI NO HAY USUARIO: Redirigir
      alert("Debes iniciar sesi√≥n para ver tu perfil.");
      window.location.href = '/auth';
  } else {
      // SI HAY USUARIO: Cargar datos
      loadProfileData(user.userId);
      loadUserReviews(user.userId);
      setupUpdateForm(user.userId);
  }

  // --- FUNCIONES ---

  async function loadProfileData(userId: number) {
      try {
          const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
              headers: getAuthHeaders()
          });

          if (!response.ok) throw response;
          
          const profile: UserProfile = await response.json();
          
          updateElementText('profile-name-display', profile.name);
          updateElementText('profile-email-display', profile.email);
          const initial = profile.name ? profile.name.charAt(0).toUpperCase() : '?';
          updateElementText('profile-initial', initial);
          
          const roleEl = document.getElementById('profile-role-display');
          if (roleEl) {
              roleEl.textContent = profile.role;
              roleEl.classList.remove('hidden');
          }

          const nameInput = document.getElementById('name') as HTMLInputElement;
          const emailInput = document.getElementById('email') as HTMLInputElement;
          if (nameInput) nameInput.value = profile.name;
          if (emailInput) emailInput.value = profile.email;

      } catch (error: any) {
          console.error(error);
          if (error.status === 401 || error.status === 403) {
             localStorage.removeItem('token');
             localStorage.removeItem('user');
             window.location.href = '/auth'; 
          }
      }
  }

  async function loadUserReviews(userId: number) {
      const listContainer = document.getElementById('user-reviews-list');
      const loadingSpinner = document.getElementById('loading-reviews');
      const noReviewsMsg = document.getElementById('no-reviews-message');

      try {
          const response = await fetch(`${API_BASE_URL}/users/${userId}/reviews`, {
              headers: getAuthHeaders()
          });

          if (!response.ok) throw new Error('Error al cargar rese√±as');

          const reviews = await response.json();
          
          loadingSpinner?.classList.add('hidden');
          
          if (reviews.length === 0) {
              noReviewsMsg?.classList.remove('hidden');
              return;
          }

          const existingReviews = listContainer?.querySelectorAll('.review-item');
          existingReviews?.forEach(el => el.remove());

          reviews.forEach((review: any) => {
              listContainer?.insertAdjacentHTML('beforeend', createReviewHtml(review));
          });

          document.querySelectorAll('.delete-review-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                  const target = e.currentTarget as HTMLElement;
                  const reviewId = target.dataset.reviewId;
                  if (reviewId) deleteReview(reviewId, userId);
              });
          });

      } catch (error) {
          console.error(error);
          if(listContainer) {
             const errorMsg = document.createElement('p');
             errorMsg.className = 'text-red-500 text-center';
             errorMsg.textContent = 'Error al cargar tus rese√±as.';
             listContainer.appendChild(errorMsg);
             loadingSpinner?.classList.add('hidden');
          }
      }
  }

  async function deleteReview(reviewId: string, userId: number) {
      if (!confirm('¬øEst√°s seguro de eliminar esta rese√±a? Esta acci√≥n no se puede deshacer.')) return;

      const btn = document.querySelector(`button[data-review-id="${reviewId}"]`) as HTMLButtonElement;
      const originalText = btn?.innerText || 'Eliminar';
      if(btn) {
          btn.disabled = true;
          btn.textContent = '...';
      }

      try {
          const response = await fetch(`${API_BASE_URL}/users/${userId}/reviews/${reviewId}`, {
              method: 'DELETE',
              headers: getAuthHeaders()
          });

          if (!response.ok) throw new Error('Error al eliminar');

          const reviewCard = document.getElementById(`review-${reviewId}`);
          if (reviewCard) {
              reviewCard.style.transition = 'opacity 0.3s, height 0.3s';
              reviewCard.style.opacity = '0';
              setTimeout(() => {
                  reviewCard.remove();
                  const remaining = document.querySelectorAll('.review-item');
                  if (remaining.length === 0) {
                      document.getElementById('no-reviews-message')?.classList.remove('hidden');
                  }
              }, 300);
          }

      } catch (error: any) {
          alert('Error al eliminar la rese√±a');
          if(btn) {
              btn.disabled = false;
              btn.textContent = originalText;
          }
      }
  }

  function setupUpdateForm(userId: number) {
      const form = document.getElementById('updateProfileForm') as HTMLFormElement;
      if(!form) return;
      
      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const btn = document.getElementById('saveChangesBtn') as HTMLButtonElement;
          const msgDiv = document.getElementById('update-message')!;
          const msgText = msgDiv.querySelector('p')!;
          
          // Inputs
          const nameInput = document.getElementById('name') as HTMLInputElement;
          const currentPassInput = document.getElementById('current-password') as HTMLInputElement;
          const newPassInput = document.getElementById('new-password') as HTMLInputElement;
          const confirmPassInput = document.getElementById('confirm-password') as HTMLInputElement;

          // Limpiar mensajes previos
          msgDiv.classList.add('hidden');
          msgDiv.className = 'hidden p-3 rounded-lg border';

          // --- VALIDACI√ìN DE CONTRASE√ëAS ---
          const newPassword = newPassInput.value.trim();
          const confirmPassword = confirmPassInput.value.trim();
          const currentPassword = currentPassInput.value.trim();
          let body: any = { name: nameInput.value };

          // Si el usuario intenta cambiar la contrase√±a
          if (newPassword || confirmPassword) {
              
              // 1. Verificar que ambas coinciden
              if (newPassword !== confirmPassword) {
                  msgDiv.className = 'p-3 rounded-lg border bg-red-50 border-red-200 block mb-4';
                  msgText.className = 'text-sm text-red-600';
                  msgText.textContent = 'Las nuevas contrase√±as no coinciden.';
                  msgDiv.classList.remove('hidden');
                  return; // Detener env√≠o
              }

              // 2. Verificar longitud m√≠nima
              if (newPassword.length < 6) {
                  msgDiv.className = 'p-3 rounded-lg border bg-red-50 border-red-200 block mb-4';
                  msgText.className = 'text-sm text-red-600';
                  msgText.textContent = 'La nueva contrase√±a debe tener al menos 6 caracteres.';
                  msgDiv.classList.remove('hidden');
                  return;
              }

              // Agregar al body para enviar al backend
              body.password = newPassword;
          }

          // Estado de carga
          btn.disabled = true;
          btn.textContent = 'Guardando...';

          try {
              const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                  method: 'PUT',
                  headers: getAuthHeaders(),
                  body: JSON.stringify(body)
              });

              const data = await response.json();

              if (!response.ok) {
                  throw new Error(data.message || (data.errors ? Object.values(data.errors).join(', ') : 'Error al actualizar'));
              }

              // √âXITO
              msgDiv.className = 'p-3 rounded-lg border bg-green-50 border-green-200 block mb-4';
              msgText.className = 'text-sm text-green-600';
              msgText.textContent = 'Perfil actualizado correctamente.';
              msgDiv.classList.remove('hidden');
              
              // Actualizar sesi√≥n local
              const currentUser = getCurrentUser();
              if(currentUser) {
                  currentUser.name = data.name;
                  localStorage.setItem('user', JSON.stringify(currentUser));
              }
              updateElementText('profile-name-display', data.name);
              
              // Limpiar campos de contrase√±a por seguridad
              if (currentPassInput) currentPassInput.value = '';
              if (newPassInput) newPassInput.value = '';
              if (confirmPassInput) confirmPassInput.value = '';

          } catch (error: any) {
              msgDiv.className = 'p-3 rounded-lg border bg-red-50 border-red-200 block mb-4';
              msgText.className = 'text-sm text-red-600';
              msgText.textContent = error.message;
              msgDiv.classList.remove('hidden');
          } finally {
              btn.disabled = false;
              btn.textContent = 'Guardar Cambios';
          }
      });
  }

  function updateElementText(id: string, text: string) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
  }

  function formatDate(dateString: string) {
      const date = new Date(dateString);
      return date.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
  }

  function createReviewHtml(review: any) {
      const userName = review.userName || "Usuario"; 
      const reviewDate = formatDate(review.createdAt);
      const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
      
      const statusMap: Record<string, string> = {
          'Approved': '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full border border-green-200">Aprobada</span>',
          'Pending': '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full border border-yellow-200">Pendiente</span>',
          'Rejected': '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full border border-red-200">Rechazada</span>'
      };
      const statusBadge = statusMap[String(review.status)] || `<span class="text-xs text-gray-500">${review.status}</span>`;
      
      return `
          <div id="review-${review.reviewId}" class="review-item p-4 border border-gray-100 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start gap-4 bg-gray-50/50 hover:bg-white transition-colors">
            <div class="flex-grow space-y-2 w-full">
                <div class="flex items-center gap-2 flex-wrap">
                    <p class="text-sm text-gray-600 font-semibold">${userName}</p>
                    <p class="text-xs text-gray-500">(${reviewDate})</p>
                    ${statusBadge}
                </div>
                <div class="text-xl font-bold text-yellow-400 tracking-wide drop-shadow-sm">${stars}</div>
                <p class="text-gray-700 text-sm md:text-base leading-relaxed">${review.comment}</p>
                <div class="text-sm text-gray-500 pt-2 border-t border-gray-200/50 mt-2 flex flex-wrap gap-1">
                    <span class="mr-1">Profesor:</span> 
                    <a href="/professor?id=${review.professorId}" class="font-medium text-green-600 hover:underline hover:text-green-700 transition-colors">${review.professorName}</a> 
                    <span class="mx-1 text-gray-300">|</span>
                    <span class="mr-1">Materia:</span>
                    <span class="font-medium text-gray-700">${review.subjectName}</span>
                </div>
                <div class="flex items-center gap-4 text-xs text-gray-400 pt-1">
                    <span class="flex items-center gap-1" title="Votos √∫tiles">üëç ${review.likeCount || 0}</span>
                    <span class="flex items-center gap-1" title="Votos negativos">üëé ${review.dislikeCount || 0}</span>
                </div>
            </div>
            <button data-review-id="${review.reviewId}" class="delete-review-btn shrink-0 px-3 py-1.5 bg-white text-red-600 text-xs font-medium rounded-md hover:bg-red-50 hover:text-red-700 border border-red-200 shadow-sm transition-all duration-200 w-full sm:w-auto text-center">
              Eliminar
            </button>
          </div>
      `;
  }
</script>