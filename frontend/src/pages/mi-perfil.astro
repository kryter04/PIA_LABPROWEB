---
// src/pages/mi-perfil.astro
import MainLayout from '../layouts/MainLayout.astro';
// Este archivo implementa la funcionalidad de la pantalla "Mi Perfil" (Wireframe Page 11)
// Permite al usuario ver su información, editarla y gestionar sus comentarios.
---

<MainLayout title="Mi Perfil">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-1">
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 sticky lg:top-24">
        <div class="flex flex-col items-center text-center">
          <div class="relative mb-4">
            <svg class="h-24 w-24 text-gray-500 bg-gray-200 rounded-full p-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <div class="absolute bottom-0 right-0 bg-brand-green p-1 rounded-full border-2 border-white">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.794.793-2.828-2.828.793-.793zm-3.18 3.18l-5 5V15h5l5-5-2.828-2.828-2.172-2.172z"/>
              </svg>
            </div>
          </div>
          <h2 id="profile-name-display" class="text-xl font-semibold text-gray-900">Cargando Nombre...</h2>
          <p id="profile-email-display" class="text-sm text-gray-600">cargando@email.com</p>
        </div>
      </div>
    </div>

    <div class="lg:col-span-2 space-y-10">

      <div class="bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Editar Perfil</h3>
        <form id="updateProfileForm" class="space-y-6">
          <div id="update-error" class="hidden p-3 rounded-lg bg-red-50 border border-red-200">
            <p class="text-sm text-red-600"></p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
              <input type="text" id="name" name="name" required minlength="2"
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-green focus:border-brand-green sm:text-sm"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
              <input type="email" id="email" name="email" readonly
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-500 cursor-not-allowed sm:text-sm"
              />
            </div>
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
            <input type="password" id="password" name="password" minlength="6" placeholder="Dejar vacío para no cambiar"
              class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-green focus:border-brand-green sm:text-sm"
            />
            <p class="mt-1 text-xs text-gray-500">Mínimo 6 caracteres (dejar vacío para no cambiar)</p>
          </div>

          <div class="text-right">
            <button type="submit" id="saveChangesBtn"
              class="w-full md:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-brand-green hover:bg-opacity-80 transition-colors"
            >
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>

      <div class="bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Mis Comentarios</h3>
        <div id="user-reviews-list" class="space-y-6">
          <p id="no-reviews-message" class="hidden text-gray-500 italic">Aún no has escrito ninguna reseña.</p>
          <div id="loading-reviews" class="text-center text-gray-500">Cargando reseñas...</div>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script is:inline>
  import $ from 'jquery';
  // API BASE URL, ajusta si es necesario
  const API_BASE_URL = 'http://localhost:8080/api'; 
  
  // Función de ayuda para formatear la fecha a un formato legible
  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
  };
  
  // Función para obtener el token y el ID del usuario de localStorage
  const getAuthData = () => {
    const token = localStorage.getItem('token');
    const userString = localStorage.getItem('user');
    if (!token || !userString) {
      return { token: null, userId: null };
    }
    try {
      const user = JSON.parse(userString);
      return { token, userId: user.userId };
    } catch (e) {
      console.error("Error al parsear los datos de usuario de localStorage", e);
      return { token: null, userId: null };
    }
  };

  // Redirigir si el usuario no está autenticado
  const checkAuth = () => {
    const { token } = getAuthData();
    if (!token) {
      alert("Debes iniciar sesión para ver tu perfil.");
      window.location.href = '/auth'; 
    }
  };

  // ===================================
  // INICIO DE LÓGICA
  // ===================================
  $(function() {
    checkAuth();
    const { token, userId } = getAuthData();
    if (!userId || !token) return;

    // 1. Cargar datos del perfil
    const loadProfileData = async () => {
      try {
        const profileResponse = await $.ajax({
          url: `${API_BASE_URL}/users/${userId}`,
          type: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        // Rellenar la tarjeta de perfil
        $('#profile-name-display').text(profileResponse.name);
        $('#profile-email-display').text(profileResponse.email);

        // Rellenar el formulario de edición
        $('#name').val(profileResponse.name);
        $('#email').val(profileResponse.email);
        
      } catch (error) { // FIX: Se eliminó : any
        console.error("Error al cargar el perfil:", error);
        // Si el token es inválido, forzar logout
        if (error.status === 401 || error.status === 403) {
             localStorage.removeItem('token');
             localStorage.removeItem('user');
             window.location.href = '/auth'; 
        }
      }
    };

    // 2. Cargar reseñas del usuario
    const loadUserReviews = async () => {
      const $reviewsList = $('#user-reviews-list');
      $reviewsList.html('<div id="loading-reviews" class="text-center text-gray-500">Cargando reseñas...</div>');
      
      try {
        const reviewsResponse = await $.ajax({
          url: `${API_BASE_URL}/users/${userId}/reviews`,
          type: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        $reviewsList.empty(); 
        
        if (reviewsResponse.length === 0) {
          $('#no-reviews-message').removeClass('hidden');
          $reviewsList.append($('#no-reviews-message'));
        } else {
          reviewsResponse.forEach(review => {
            const reviewHtml = createReviewHtml(review);
            $reviewsList.append(reviewHtml);
          });
        }
      } catch (error) {
        console.error("Error al cargar las reseñas:", error);
        $reviewsList.html('<p class="text-red-500">Error al cargar tus reseñas.</p>');
      }
    };

    // Helper para crear el HTML de una reseña
    const createReviewHtml = (review) => {
        // Se usa el nombre del usuario de la reseña, que puede ser 'Anonymous' si es anónima.
        const userName = review.userName || "Usuario"; 
        const reviewDate = formatDate(review.createdAt);
        
        // Generar estrellas visuales
        const stars = '★★★★★'.substring(0, review.rating);
        const emptyStars = '☆☆☆☆☆'.substring(review.rating);
        const starsHtml = `<span class="text-yellow-500">${stars}</span><span class="text-gray-300">${emptyStars}</span>`;


        const html = `
          <div id="review-${review.reviewId}" class="p-4 border border-gray-100 rounded-lg shadow-sm flex justify-between items-start">
            <div class="flex-grow space-y-2">
                <div class="flex items-center space-x-3">
                    <p class="text-sm text-gray-600 font-semibold">${userName}</p>
                    <p class="text-xs text-gray-500">(${reviewDate})</p>
                </div>
                
                <p class="text-xl font-bold">${starsHtml}</p>
                <p class="text-gray-700">${review.comment}</p>
                
                <p class="text-sm text-gray-500 pt-1">
                    Sobre <span class="font-medium text-brand-green">${review.professorName}</span> en <span class="font-medium">${review.subjectName}</span>
                </p>
                
                <div class="flex items-center space-x-4 text-sm text-gray-500 pt-2">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.43-.27-.85-.64-1.07L15 2l-6 6-1.5 1.5V21h10.31c.88 0 1.6-.54 1.84-1.3l2.84-8.02c.24-.68-.21-1.38-1-1.38z"/></svg>
                        ${review.likeCount || 0}
                    </span>
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h4v12h-4V3zm-2 0H6.69c-.88 0-1.6.54-1.84 1.3L2.01 12.32c-.24.68.21 1.38 1 1.38h6.31l-.95 4.57-.03.32c0 .43.27.85.64 1.07L9 22l6-6 1.5-1.5V3H17z"/></svg>
                        ${review.dislikeCount || 0}
                    </span>
                    <span class="text-xs italic text-gray-400">Estado: ${review.status}</span>
                </div>
            </div>
            
            <button data-review-id="${review.reviewId}" class="delete-review-btn rounded-md bg-brand-red px-3 py-1 text-xs font-semibold text-white shadow-sm hover:bg-red-700 transition-colors ml-4 whitespace-nowrap">
              Eliminar
            </button>
          </div>
        `;
        return html;
    };

    // 3. Manejar la eliminación de reseñas
    $(document).on('click', '.delete-review-btn', async function() {
        const reviewId = $(this).data('review-id');
        if (!confirm(`¿Estás seguro de que deseas eliminar esta reseña (ID: ${reviewId})? Esta acción es irreversible.`)) {
            return;
        }

        const $btn = $(this);
        const originalText = $btn.text();
        
        try {
            $btn.prop('disabled', true).text('Eliminando...');

            await $.ajax({
                url: `${API_BASE_URL}/users/${userId}/reviews/${reviewId}`,
                type: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            // Éxito: Remover visualmente la reseña
            $(`#review-${reviewId}`).slideUp(300, function() {
                $(this).remove();
                if ($('#user-reviews-list').children().length === 0) {
                    $('#no-reviews-message').removeClass('hidden');
                    $('#user-reviews-list').append($('#no-reviews-message'));
                }
            });
            
        } catch (error) { // FIX: Se eliminó : any
            console.error("Error al eliminar la reseña:", error);
            alert("Error al eliminar la reseña: " + (error.responseJSON?.message || "Hubo un problema."));
            $btn.prop('disabled', false).text(originalText);
        }
    });

    // 4. Manejar la actualización del perfil
    $('#updateProfileForm').on('submit', async function(e) {
        e.preventDefault();
        
        const $form = $(this);
        const $btn = $('#saveChangesBtn');
        const $errorDiv = $('#update-error');
        
        $errorDiv.addClass('hidden').find('p').text('');
        $btn.prop('disabled', true).text('Guardando...');

        const name = $form.find('#name').val();
        const password = $form.find('#password').val();
        
        // Solo enviamos los campos que tienen valor y no están vacíos
        const requestData = {};
        if (name && name.trim() !== '') {
            requestData.name = name;
        }
        if (password && password.trim() !== '') {
            requestData.password = password;
        }

        if (Object.keys(requestData).length === 0) {
             $errorDiv.removeClass('hidden').find('p').text('No hay cambios para guardar.');
             $btn.prop('disabled', false).text('Guardar Cambios');
             return;
        }

        try {
            const updateResponse = await $.ajax({
                url: `${API_BASE_URL}/users/${userId}`,
                type: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(requestData)
            });

            // Éxito: Actualizar localStorage, UI y limpiar password
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            user.name = updateResponse.name;
            localStorage.setItem('user', JSON.stringify(user));
            
            $('#profile-name-display').text(updateResponse.name);
            $form.find('#password').val('');
            
            alert("Perfil actualizado con éxito.");
            
        } catch (error) { // FIX: Se eliminó : any
            console.error("Error al actualizar el perfil:", error);
            let errorMessage = "Error al actualizar el perfil. Intenta de nuevo.";

            // Extraer mensaje de error del backend
            if (error.responseJSON?.message) {
                 errorMessage = error.responseJSON.message;
            } else if (error.responseJSON?.errors) {
                 // Errores de validación
                errorMessage = Object.values(error.responseJSON.errors).join(', ');
            }
            
            $errorDiv.removeClass('hidden').find('p').text(errorMessage);
        } finally {
            $btn.prop('disabled', false).text('Guardar Cambios');
        }
    });

    // Iniciar carga de datos al cargar la página
    loadProfileData();
    loadUserReviews();
  });
</script>