---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Escribir Reseña">
  <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-100">
    
    <div class="mb-8 pb-6 border-b border-gray-100 text-center">
        <div id="loading-prof" class="animate-pulse">
            <div class="h-6 bg-gray-200 rounded w-1/2 mx-auto mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/3 mx-auto"></div>
        </div>
        
        <div id="prof-info" class="hidden">
            <h1 class="text-2xl font-bold text-gray-900">
                Califica a <span id="prof-name" class="text-green-600"></span>
            </h1>
            <p id="prof-dept" class="text-gray-500 mt-1 text-sm"></p>
        </div>
    </div>

    <form id="create-review-form" class="space-y-6">
      <input type="hidden" id="professor-id" />

      <div>
        <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-2">
            ¿Qué materia tomaste con él/ella?
        </label>
        <select id="subject-select" required
          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white"
        >
          <option value="">Selecciona una materia...</option>
          </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Calificación General</label>
        <div class="flex items-center gap-1" id="star-container">
            <button type="button" data-value="1" class="star-btn text-4xl text-gray-300 hover:scale-110 transition-transform focus:outline-none">★</button>
            <button type="button" data-value="2" class="star-btn text-4xl text-gray-300 hover:scale-110 transition-transform focus:outline-none">★</button>
            <button type="button" data-value="3" class="star-btn text-4xl text-gray-300 hover:scale-110 transition-transform focus:outline-none">★</button>
            <button type="button" data-value="4" class="star-btn text-4xl text-gray-300 hover:scale-110 transition-transform focus:outline-none">★</button>
            <button type="button" data-value="5" class="star-btn text-4xl text-gray-300 hover:scale-110 transition-transform focus:outline-none">★</button>
        </div>
        <input type="hidden" id="rating-input" name="rating" required />
        <p id="rating-error" class="text-red-500 text-xs mt-1 hidden">Por favor selecciona una calificación.</p>
      </div>

      <div>
        <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">
            Tu Reseña
        </label>
        <textarea 
            id="comment" 
            name="comment" 
            rows="5" 
            required 
            minlength="10" 
            maxlength="1000"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
            placeholder="¿Cómo explica? ¿Es justo calificando? Comparte tu experiencia (mínimo 10 caracteres)."
        ></textarea>
        <div class="flex justify-between mt-1">
            <span class="text-xs text-gray-500">Mínimo 10 caracteres</span>
            <span id="char-count" class="text-xs text-gray-400">0/1000</span>
        </div>
      </div>

      <div class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
        <input 
            id="anonymous" 
            name="isAnonymous" 
            type="checkbox" 
            class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer"
        >
        <label for="anonymous" class="ml-3 block text-sm text-gray-700 cursor-pointer select-none">
          Publicar de forma <strong>anónima</strong>
        </label>
      </div>

      <div class="flex gap-4 pt-4">
        <a href="javascript:history.back()" 
           class="w-1/3 py-3 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 text-center transition-colors">
           Cancelar
        </a>
        <button 
            type="submit" 
            id="submit-btn"
            class="w-2/3 py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Enviar Reseña
        </button>
      </div>
    </form>
  </div>
</MainLayout>

<script>
    import { API_BASE_URL, getAuthHeaders, getCurrentUser } from '../config/api.ts';

    // 1. Obtener ID del profesor de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const professorId = urlParams.get('id');

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
        // Verificar Auth
        if (!getCurrentUser()) {
            alert('Necesitas iniciar sesión para escribir una reseña.');
            window.location.href = `/auth?redirect=/crear-resena?id=${professorId}`;
            return;
        }

        if (!professorId) {
            alert('Error: No se especificó un profesor.');
            window.location.href = '/';
            return;
        }

        loadProfessorDetails(professorId);
        setupStarRating();
        setupForm();
        setupCharCounter();
    });

    // 2. Cargar datos del profesor (Nombre y Materias)
    async function loadProfessorDetails(id: string) {
        try {
            const response = await fetch(`${API_BASE_URL}/professors/${id}`);
            if (!response.ok) throw new Error('Profesor no encontrado');
            
            const prof = await response.json();

            // Llenar UI
            document.getElementById('prof-name')!.textContent = prof.name;
            document.getElementById('prof-dept')!.textContent = prof.departmentName || 'Departamento no especificado';
            
            // Llenar Select de Materias
            const select = document.getElementById('subject-select') as HTMLSelectElement;
            const subjectsResponse = await fetch(`${API_BASE_URL}/subjects`);
            const allSubjects = await subjectsResponse.json();

            // Filtrar las materias que da el profe
            const profSubjectNames = prof.subjects || [];
            
            // Crear opciones
            allSubjects.forEach((subj: any) => {
                // Solo mostramos las materias que coinciden con las del profe, 
                // O mostramos todas si la lista del profe está vacía (caso borde)
                if (profSubjectNames.includes(subj.name) || profSubjectNames.length === 0) {
                    const option = document.createElement('option');
                    option.value = subj.subjectId;
                    option.textContent = subj.name;
                    select.appendChild(option);
                }
            });

            // Mostrar contenedor
            document.getElementById('loading-prof')!.classList.add('hidden');
            document.getElementById('prof-info')!.classList.remove('hidden');
            (document.getElementById('professor-id') as HTMLInputElement).value = id;

        } catch (error) {
            console.error(error);
            alert('No se pudo cargar la información del profesor.');
            window.location.href = '/';
        }
    }

    // 3. Lógica de Estrellas
    function setupStarRating() {
        const stars = document.querySelectorAll('.star-btn');
        const input = document.getElementById('rating-input') as HTMLInputElement;
        const errorMsg = document.getElementById('rating-error')!;

        stars.forEach(star => {
            star.addEventListener('click', () => {
                const value = parseInt(star.getAttribute('data-value')!);
                input.value = value.toString();
                errorMsg.classList.add('hidden');

                // Pintar estrellas
                stars.forEach((s, index) => {
                    if (index < value) {
                        s.classList.remove('text-gray-300');
                        s.classList.add('text-yellow-400');
                    } else {
                        s.classList.remove('text-yellow-400');
                        s.classList.add('text-gray-300');
                    }
                });
            });
        });
    }

    // 4. Contador de caracteres
    function setupCharCounter() {
        const textarea = document.getElementById('comment') as HTMLTextAreaElement;
        const counter = document.getElementById('char-count')!;
        
        textarea.addEventListener('input', () => {
            const len = textarea.value.length;
            counter.textContent = `${len}/1000`;
            if (len >= 1000) counter.classList.add('text-red-500');
            else counter.classList.remove('text-red-500');
        });
    }

    // 5. Enviar Formulario
    function setupForm() {
        const form = document.getElementById('create-review-form') as HTMLFormElement;
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('submit-btn') as HTMLButtonElement;
            const rating = (document.getElementById('rating-input') as HTMLInputElement).value;

            if (!rating) {
                document.getElementById('rating-error')!.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Enviando...';

            const formData = {
                professorId: parseInt((document.getElementById('professor-id') as HTMLInputElement).value),
                subjectId: parseInt((document.getElementById('subject-select') as HTMLSelectElement).value),
                rating: parseInt(rating),
                comment: (document.getElementById('comment') as HTMLTextAreaElement).value,
                isAnonymous: (document.getElementById('anonymous') as HTMLInputElement).checked === true,
                imageUrls: [] // Por ahora vacío, feature futura
            };
            
            console.log('sending review data:', formData);

            try {
                const response = await fetch(`${API_BASE_URL}/reviews`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al crear la reseña');
                }

                // Éxito
                alert('¡Reseña enviada con éxito! Estará visible una vez sea aprobada por moderación.');
                window.location.href = `/professor?id=${formData.professorId}`;

            } catch (error: any) {
                console.error(error);
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'Enviar Reseña';
            }
        });
    }
</script>