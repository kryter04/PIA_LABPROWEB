---
import MainLayout from '../../layouts/MainLayout.astro';

// Esta ruta se resuelve en tiempo de ejecuci√≥n (no est√°tica)
export const prerender = false;

const { id } = Astro.params;

type Review = {
  reviewId: number;
  userId: number | null;
  userName: string | null;
  rating: number;
  comment: string;
  isAnonymous: boolean;
  status: string;
  createdAt: string;
  totalVotes: number;
  likeCount: number;
  dislikeCount: number;
};

type ProfessorDetail = {
  professorId: number;
  name: string;
  title: string;
  departmentName: string;
  photoUrl: string | null;
  averageRating: number | null;
  reviewCount: number;
  universities: string[];
  subjects: string[];
  reviews: Review[];
};

let professor: ProfessorDetail | null = null;
let hasError = false;

// Helpers
const getStars = (rating: number | null | undefined) =>
  Array.from({ length: 5 }, (_, i) => i < Math.round(rating ?? 0));

function formatRelative(dateStr?: string | null) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '';
  const diffMs = Date.now() - d.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  if (diffDays <= 0) return 'Hoy';
  if (diffDays < 30) return `Hace ${diffDays} d√≠a${diffDays === 1 ? '' : 's'}`;
  const months = Math.floor(diffDays / 30);
  return `Hace ${months} mes${months === 1 ? '' : 'es'}`;
}

function buildRatingStats(reviews: Review[] = []) {
  const counts: Record<number, number> = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
  for (const r of reviews) {
    const val = Math.round(r.rating ?? 0);
    if (val >= 1 && val <= 5) counts[val]++;
  }
  const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
  return [5, 4, 3, 2, 1].map((star) => {
    const value = counts[star];
    const percentage = Math.round((value / total) * 100);
    return { star, value, percentage };
  });
}

// üî• AQU√ç SOLO USAMOS LA API REAL
try {
  const res = await fetch(`/api/professors/${id}`);

  if (res.ok) {
    professor = (await res.json()) as ProfessorDetail;
  } else {
    console.error('Error al obtener profesor:', res.status);
    hasError = true;
  }
} catch (err) {
  console.error('Error al conectar con el backend:', err);
  hasError = true;
}

const ratingStats = professor ? buildRatingStats(professor.reviews ?? []) : [];
const avgRating = professor?.averageRating ?? null;
const totalReviews = professor?.reviewCount ?? professor?.reviews?.length ?? 0;
---

<MainLayout title={professor ? professor.name : 'Detalle de profesor'}>
  <main class="max-w-5xl mx-auto px-4 py-10 space-y-6">

    {hasError && (
      <p class="rounded-lg bg-red-50 border border-red-100 px-4 py-2 text-sm text-red-700">
        No se pudo cargar la informaci√≥n del profesor. Verifica que el backend est√©
        levantado y que exista el profesor con id {id}.
      </p>
    )}

    {professor && (
      <>
        <!-- Encabezado del perfil -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex gap-4 items-center">
          <div class="flex-shrink-0">
            <div class="h-24 w-24 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center">
              {professor.photoUrl ? (
                <img
                  src={professor.photoUrl}
                  alt={professor.name}
                  class="h-full w-full object-cover"
                />
              ) : (
                <span class="text-3xl text-gray-500">
                  {professor.name.charAt(0)}
                </span>
              )}
            </div>
          </div>

          <div class="flex-1 space-y-1">
            <h1 class="text-2xl font-semibold text-gray-900">
              {professor.name}
            </h1>
            <p class="text-sm text-green-600">
              {professor.title}
            </p>
            <p class="text-xs text-gray-500">
              {professor.departmentName}
            </p>
          </div>
        </section>

        <!-- Resumen de calificaciones -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-base font-semibold text-gray-900 mb-4">
            Resumen de Calificaciones
          </h2>

          <div class="flex flex-col gap-6 md:flex-row">
            <!-- Promedio -->
            <div class="md:w-1/3 flex flex-col items-start">
              <p class="text-4xl font-semibold text-gray-900">
                {avgRating ? avgRating.toFixed(1) : '‚Äî'}
              </p>
              <div class="mt-1 flex items-center gap-1">
                <div class="flex">
                  {getStars(avgRating).map((filled) => (
                    <span
                      class={filled ? 'text-green-500' : 'text-gray-300'}
                      aria-hidden="true"
                    >
                      ‚òÖ
                    </span>
                  ))}
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">
                Basado en {totalReviews} rese√±a{totalReviews === 1 ? '' : 's'}
              </p>
            </div>

            <!-- Barras -->
            <div class="md:w-2/3 space-y-2">
              {ratingStats.map((row) => (
                <div class="flex items-center gap-2 text-xs text-gray-600">
                  <span class="w-3 text-right">{row.star}</span>
                  <span class="text-[10px] text-gray-500">‚òÖ</span>
                  <div class="flex-1 h-2 rounded-full bg-gray-100 overflow-hidden">
                    <div
                      class="h-2 bg-green-500"
                      style={`width: ${row.percentage}%;`}
                    ></div>
                  </div>
                  <span class="w-10 text-right">
                    {row.percentage}%
                  </span>
                </div>
              ))}
            </div>
          </div>

          <!-- Bot√≥n de rese√±a -->
          <div class="mt-6 flex items-center justify-between gap-4 border-t border-gray-100 pt-4">
            <p class="text-sm font-semibold text-gray-900">
              Rese√±as de Estudiantes
            </p>
            <div class="flex flex-col items-end gap-1">
              <button
                type="button"
                class="rounded-full bg-gray-200 text-gray-500 text-xs px-4 py-1 cursor-not-allowed"
              >
                Escribir Rese√±a
              </button>
              <p class="text-[11px] text-gray-400">
                Debes iniciar sesi√≥n para escribir una rese√±a.
              </p>
            </div>
          </div>
        </section>

        <!-- Rese√±as de estudiantes -->
        <section class="space-y-3">
          {(!professor.reviews || professor.reviews.length === 0) ? (
            <p class="text-sm text-gray-500">
              A√∫n no hay rese√±as registradas para este profesor.
            </p>
          ) : (
            professor.reviews.map((review) => (
              <article class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex gap-3">
                <div class="flex-shrink-0">
                  <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                    <span class="text-xs text-gray-600">
                      {review.userName?.charAt(0) ?? 'A'}
                    </span>
                  </div>
                </div>

                <div class="flex-1">
                  <header class="flex flex-wrap items-center justify-between gap-2 mb-1">
                    <div>
                      <p class="text-sm font-semibold text-gray-900">
                        {review.userName ?? 'Estudiante'}
                      </p>
                      <p class="text-[11px] text-gray-400">
                        {formatRelative(review.createdAt)}
                      </p>
                    </div>

                    <div class="flex items-center gap-1">
                      <div class="flex text-xs">
                        {getStars(review.rating).map((filled) => (
                          <span
                            class={filled ? 'text-green-500' : 'text-gray-300'}
                            aria-hidden="true"
                          >
                            ‚òÖ
                          </span>
                        ))}
                      </div>
                    </div>
                  </header>

                  <p class="text-sm text-gray-700 mb-2">
                    {review.comment}
                  </p>

                  <footer class="flex items-center gap-4 text-xs text-gray-500">
                    <span>üëç {review.likeCount}</span>
                    <span>üëé {review.dislikeCount}</span>
                  </footer>
                </div>
              </article>
            ))
          )}
        </section>
      </>
    )}

    {!hasError && !professor && (
      <p class="text-sm text-gray-500">
        No se encontr√≥ el profesor con id {id}.
      </p>
    )}
  </main>
</MainLayout>
