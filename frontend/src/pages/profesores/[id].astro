---
import MainLayout from '../../layouts/MainLayout.astro';

// Ruta din√°mica ‚Üí se resuelve en runtime, no est√°tica
export const prerender = false;

const { id } = Astro.params;

type Review = {
  reviewId: number;
  userName: string | null;
  rating: number;
  comment: string;
  createdAt: string;
  likeCount: number;
  dislikeCount: number;
};

type ProfessorDetail = {
  professorId: number;
  name: string;
  title: string;
  departmentName: string;
  photoUrl: string | null;
  averageRating: number | null;
  reviewCount: number;
  universities: string[];
  subjects: string[];
  reviews: Review[];
};

let professor: ProfessorDetail | null = null;
let hasError = false;

// ===== Helpers para estrellas y distribuci√≥n =====

type StarType = 'full' | 'half' | 'empty';

function buildStars(rating: number | null | undefined): StarType[] {
  if (!rating || rating <= 0) return ['empty', 'empty', 'empty', 'empty', 'empty'];
  const full = Math.floor(rating);
  const hasHalf = rating - full >= 0.5;
  const stars: StarType[] = [];
  for (let i = 0; i < 5; i++) {
    if (i < full) stars.push('full');
    else if (i === full && hasHalf) stars.push('half');
    else stars.push('empty');
  }
  return stars;
}

function buildRatingStats(reviews: Review[] = []) {
  const counts: Record<number, number> = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
  for (const r of reviews) {
    const val = Math.round(r.rating ?? 0);
    if (val >= 1 && val <= 5) counts[val]++;
  }
  const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
  return [5, 4, 3, 2, 1].map((star) => {
    const value = counts[star];
    const percentage = Math.round((value / total) * 100);
    return { star, value, percentage };
  });
}

function formatRelative(dateStr?: string | null) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '';
  const diffMs = Date.now() - d.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  if (diffDays <= 0) return 'Hoy';
  if (diffDays < 30) return `Hace ${diffDays} d√≠a${diffDays === 1 ? '' : 's'}`;
  const months = Math.floor(diffDays / 30);
  return `Hace ${months} mes${months === 1 ? '' : 'es'}`;
}

// ===== Llamada real a la API (sin mocks) =====

try {
  // Usamos el proxy de Astro: /api ‚Üí backend :8080
  const res = await fetch(`/api/professors/${id}`);

  if (res.ok) {
    professor = (await res.json()) as ProfessorDetail;
  } else {
    console.error('Error al obtener profesor:', res.status);
    hasError = true;
  }
} catch (err) {
  console.error('Error al conectar con el backend:', err);
  hasError = true;
}

const ratingStats = professor ? buildRatingStats(professor.reviews ?? []) : [];
const avgRating = professor?.averageRating ?? null;
const totalReviews = professor?.reviewCount ?? professor?.reviews?.length ?? 0;
const avgStars = buildStars(avgRating);
---

<MainLayout title={professor ? professor.name : 'Detalle del profesor'}>
  <main class="max-w-5xl mx-auto px-4 py-10 space-y-6">

    {hasError && (
      <p class="rounded-lg bg-red-50 border border-red-100 px-4 py-2 text-sm text-red-700">
        No se pudo cargar la informaci√≥n del profesor. Revisa que el backend est√©
        levantado y que exista el profesor con id {id}.
      </p>
    )}

    {professor && (
      <>
        <!-- Encabezado del perfil -->
        <section class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex flex-col gap-6 md:flex-row md:items-start">
            <!-- Foto -->
            <div class="flex-shrink-0">
              <img
                src={professor.photoUrl || '/default-avatar.png'}
                alt={professor.name}
                class="w-24 h-24 rounded-full object-cover"
              />
            </div>

            <!-- Datos del profesor -->
            <div class="flex-1">
              <h1 class="text-3xl font-bold text-gray-900">
                {professor.name}
              </h1>
              <p class="text-lg text-gray-600 mt-1">
                {professor.title || 'Profesor'} de{' '}
                {professor.subjects?.join(', ') || 'N/A'}
              </p>
              <p class="text-sm text-gray-500 mt-2">
                {professor.departmentName},{' '}
                {professor.universities?.join(', ') || 'Universidad'}
              </p>
            </div>

            <!-- Rating general -->
            <div class="text-center md:w-40">
              <div class="text-4xl font-bold text-gray-900">
                {avgRating ? avgRating.toFixed(1) : '‚Äî'}
              </div>
              <div class="flex items-center justify-center gap-1 mt-1">
                {avgStars.map((t) => (
                  t === 'full' ? (
                    <span class="text-yellow-400">‚òÖ</span>
                  ) : t === 'half' ? (
                    <span class="text-yellow-400">‚òÜ</span>
                  ) : (
                    <span class="text-gray-300">‚òÖ</span>
                  )
                ))}
              </div>
              <p class="text-sm text-gray-500 mt-1">
                {totalReviews} rese√±a{totalReviews === 1 ? '' : 's'}
              </p>
            </div>
          </div>

          <!-- Distribuci√≥n de calificaciones -->
          <div class="mt-6 space-y-2">
            {ratingStats.map((row) => (
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600 w-12">{row.star} ‚òÖ</span>
                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div
                    class="h-full bg-yellow-400"
                    style={`width: ${row.percentage}%;`}
                  ></div>
                </div>
                <span class="text-sm text-gray-600 w-10 text-right">
                  {row.value}
                </span>
              </div>
            ))}
          </div>

          <!-- Bot√≥n de rese√±a (solo visual, sin l√≥gica de auth/Modal) -->
          <div class="mt-6 pt-6 border-t border-gray-200 flex items-center justify-between">
            <p class="text-base font-semibold text-gray-900">
              Rese√±as de Estudiantes
            </p>
            <div class="flex flex-col items-end gap-1">
              <button
                type="button"
                class="px-6 py-2 bg-gray-200 text-gray-500 font-medium rounded-lg cursor-not-allowed"
              >
                Escribir Rese√±a
              </button>
              <p class="text-xs text-gray-500">
                Debes iniciar sesi√≥n para escribir una rese√±a.
              </p>
            </div>
          </div>
        </section>

        <!-- Lista de rese√±as -->
        <section class="space-y-4">
          {(!professor.reviews || professor.reviews.length === 0) ? (
            <p class="text-center text-gray-500 py-8">
              No hay rese√±as a√∫n. S√© el primero en escribir una (cuando est√©
              habilitado).
            </p>
          ) : (
            professor.reviews.map((review) => {
              const reviewStars = buildStars(review.rating);
              return (
                <article class="bg-white rounded-lg shadow-sm p-6">
                  <div class="flex items-start justify-between">
                    <div class="flex items-start gap-4">
                      <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-semibold">
                        {review.userName?.[0] || 'A'}
                      </div>
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="font-medium text-gray-900">
                            {review.userName || 'An√≥nimo'}
                          </span>
                          <span class="text-sm text-gray-500">
                            ‚Ä¢ {formatRelative(review.createdAt)}
                          </span>
                        </div>
                        <div class="flex items-center gap-1 mt-1">
                          {reviewStars.map((t) => (
                            t === 'full' ? (
                              <span class="text-yellow-400">‚òÖ</span>
                            ) : t === 'half' ? (
                              <span class="text-yellow-400">‚òÜ</span>
                            ) : (
                              <span class="text-gray-300">‚òÖ</span>
                            )
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>

                  <p class="text-gray-700 mt-4">
                    {review.comment}
                  </p>

                  <div class="flex items-center gap-4 mt-4 text-sm text-gray-500">
                    <span class="flex items-center gap-1">
                      üëç {review.likeCount}
                    </span>
                    <span class="flex items-center gap-1">
                      üëé {review.dislikeCount}
                    </span>
                  </div>
                </article>
              );
            })
          )}
        </section>
      </>
    )}

    {!hasError && !professor && (
      <p class="text-sm text-gray-500">
        No se encontr√≥ el profesor con id {id}.
      </p>
    )}
  </main>
</MainLayout>
