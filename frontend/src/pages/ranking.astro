---
import MainLayout from '../layouts/MainLayout.astro';

interface RankedProfessor {
  professorId: number;
  name: string;
  title: string;
  departmentName?: string;
  photoUrl?: string;
  averageRating: number | null;
  reviewCount: number;
  universities?: string[];
  subjects?: string[];
}

let ranking: RankedProfessor[] = [];
let hasError = false;

const getStars = (rating: number | null | undefined) =>
  Array.from({ length: 5 }, (_, i) => i < Math.round(rating ?? 0));

try {
  const res = await fetch('http://localhost:8080/api/ranking?limit=10');
  if (res.ok) {
    const data = await res.json();
    ranking = (data.professors ?? []) as RankedProfessor[];
  } else {
    hasError = true;
    console.error('Error al obtener ranking:', res.status);
  }
} catch (err) {
  hasError = true;
  console.error('Error al conectar con backend:', err);
}
---

<MainLayout title="Lista de Profesores">
  <main class="max-w-5xl mx-auto px-4 py-10">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold text-gray-900">
        Lista de Profesores
      </h1>
      <p class="mt-1 text-sm text-gray-500">
        Profesores ordenados por mejor calificación.
      </p>
      {hasError && (
        <p class="mt-2 text-xs text-red-500">
          No se pudo conectar al backend, mostrando datos vacíos.
        </p>
      )}
    </header>

    <section class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-green-50 text-left text-xs font-semibold text-gray-500">
            <tr>
              <th class="px-6 py-3">Posición</th>
              <th class="px-6 py-3">Profesor</th>
              <th class="px-6 py-3">Asignatura</th>
              <th class="px-6 py-3">Universidad</th>
              <th class="px-6 py-3">Calificación</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-100">
            {ranking.length === 0 ? (
              <tr>
                <td colspan={5} class="px-6 py-6 text-center text-gray-500">
                  No hay información disponible.
                </td>
              </tr>
            ) : (
              ranking.map((p, index) => (
                <tr class="hover:bg-gray-50 transition">
                  <td class="px-6 py-4 text-gray-700 font-medium">#{index + 1}</td>

                  <td class="px-6 py-4">
                    <a
                      href={`/profesores/${p.professorId}`}
                      class="flex items-center gap-3 group"
                    >
                      <div class="h-9 w-9 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center">
                        {p.photoUrl ? (
                          <img src={p.photoUrl} class="h-full w-full object-cover" />
                        ) : (
                          <span class="text-xs text-gray-500">{p.name.charAt(0)}</span>
                        )}
                      </div>

                      <div>
                        <p class="text-sm font-medium text-gray-900 group-hover:text-green-600">
                          {p.name}
                        </p>
                        <p class="text-xs text-gray-500">
                          {p.title} · {p.departmentName ?? 'Departamento'}
                        </p>
                      </div>
                    </a>
                  </td>

                  <td class="px-6 py-4 text-gray-700">
                    {p.subjects?.[0] ?? '—'}
                  </td>

                  <td class="px-6 py-4 text-gray-700">
                    {p.universities?.[0] ?? '—'}
                  </td>

                  <td class="px-6 py-4">
                    {p.averageRating == null ? (
                      <span class="text-xs text-gray-400">Sin calificación</span>
                    ) : (
                      <div class="flex items-center gap-1">
                        <div class="flex">
                          {getStars(p.averageRating).map((filled) => (
                            <span class={filled ? 'text-yellow-400' : 'text-gray-300'}>
                              ★
                            </span>
                          ))}
                        </div>
                        <span class="ml-1 text-xs text-gray-700">
                          {p.averageRating.toFixed(1)} ({p.reviewCount} reseñas)
                        </span>
                      </div>
                    )}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </section>
  </main>
</MainLayout>
